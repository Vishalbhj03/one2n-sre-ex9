name: update-image-tag

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  update-values:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq (YAML processor)
        run: |
          set -e
          if ! command -v yq >/dev/null 2>&1; then
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
          fi
          yq --version

      - name: Determine IMAGE_TAG from triggering workflow
        run: |
          echo "Triggering run head_sha: ${{ github.event.workflow_run.head_sha }}"
          echo "IMAGE_TAG=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV

      - name: Update student-api values.yaml with new tag
        run: |
          set -e
          VALUES_FILE=charts/student-api/values.yaml

          # If .image.tag exists:
          if yq e '.image.tag' "$VALUES_FILE" >/dev/null 2>&1; then
            yq e -i ".image.tag = env(IMAGE_TAG)" "$VALUES_FILE"
          else
            # Otherwise set full image name:tag
            IMAGE_NAME="vishalbhj/student-api"
            yq e -i ".image = \"${IMAGE_NAME}:\" + env(IMAGE_TAG)" "$VALUES_FILE"
          fi
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}

      - name: Commit and push updated values.yaml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add charts/student-api/values.yaml
          git commit -m "ci: bump student-api image to ${IMAGE_TAG}" || echo "No changes to commit"
          git push origin HEAD:main
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}

